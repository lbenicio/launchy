name: Sync workflow names for notifications

on:
  push:
    paths:
      - '.github/workflows/**'

jobs:
  update-notifications:
    name: Update notifications.yml with workflow names
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Exit early if only generated workflow files changed
        id: check-files
        run: |
          set -euo pipefail
          before=${{ github.event.before }}
          after=${{ github.sha }}
          echo "before=${before}, after=${after}"
          if [ "$before" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit / branch; continuing"
            exit 0
          fi
          git fetch --no-tags origin ${GITHUB_REF} --depth=2 || true
          files=$(git diff --name-only "$before" "$after" || true)
          echo "Changed files:"$files
          if [ -z "$files" ]; then
            echo "No files changed? continuing..."
            exit 0
          fi
          # if all changed files are the generated notifications.yml or this sync file, exit
          only_generated=true
          for f in $files; do
            case "$f" in
              .github/workflows/notifications.yml|.github/workflows/sync-workflows.yml)
                ;;
              *) only_generated=false; break ;;
            esac
          done
          if [ "$only_generated" = true ]; then
            echo "Only generated workflow files changed; nothing to do."
            exit 0
          fi

      - name: Gather top-level workflow names
        id: gather
        run: |
          set -euo pipefail
          # Get top-level "name:" lines from workflow files in the directory
          shopt -s nullglob
          cd .github/workflows
          names=""
          for f in *.yml *.yaml; do
            # Grab the top-level 'name:' (non-indented) line from the file, if present
            n=$(awk '/^name:/{print substr($0, index($0,$2)) ; exit}' "$f" | sed 's/^ *//;s/ *$//') || true
            if [[ -n "$n" ]]; then
              # Ignore the special notification and sync workflows
              if [[ "$n" == "Telegram notification" || "$n" == "Sync workflow names for notifications" ]]; then
                continue
              fi
              names+="$n\n"
            fi
          done
          # Deduplicate and sort
          echo -e "$names" | sort -u | sed '/^$/d' > /tmp/workflow-names.txt || true
          echo "names=$(cat /tmp/workflow-names.txt | wc -l)" >> "$GITHUB_OUTPUT"

      - name: Render notifications.yml
        id: render
        run: |
          set -euo pipefail
          cd .github/workflows
          mapfile -t lines < /tmp/workflow-names.txt || true
          cat > notifications.yml.tmp << 'EOF'
          name: Telegram notification

          concurrency:
            group: notification-${{ github.ref }}
            cancel-in-progress: true

          on:
            workflow_run:
              workflows:
          EOF
          # Remove leading spaces from heredoc (strip 10 spaces)
          sed -i 's/^          //' notifications.yml.tmp
          for w in "${lines[@]}"; do
            printf '      - "%s"\n' "$w" >> notifications.yml.tmp
          done
          cat >> notifications.yml.tmp << 'EOF'
              branches:
                - main
              types:
                - completed
            workflow_dispatch:
          jobs:
            notification:
              runs-on: ubuntu-latest
              permissions:
                contents: read
                packages: write
              if: ${{ github.event.workflow_run.name != 'Telegram notification' }}
              steps:
                - name: Send Telegram message
                  uses: appleboy/telegram-action@master
                  with:
                    to: ${{ secrets.CHATID }}
                    token: ${{ secrets.BOTTOKEN }}
                    format: markdown
                    message: |
                      Code Deployed: ${{ github.repository }}

                      ${{ github.actor }} created commit:
                      ${{ github.event.workflow_run.head_commit.message }}

                      [View action run](${{ github.event.workflow_run.html_url }})
                      [Cancel action run](${{ github.event.workflow_run.cancel_url }})

                      Workflow: ${{ github.event.workflow_run.name }}
                      Job status: ${{ github.event.workflow_run.conclusion == 'success' && 'âœ…' || 'ðŸš«' }} ${{ github.event.workflow_run.conclusion }}

                      See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}

                - name: Publish workflow summary
                  if: always()
                  shell: bash
                  run: |
                    echo "## Notification â€“ Summary" >> "$GITHUB_STEP_SUMMARY"
                    echo "Triggered workflow: ${{ github.event.workflow_run.name }}" >> "$GITHUB_STEP_SUMMARY"
                    echo "Conclusion: ${{ github.event.workflow_run.conclusion }}" >> "$GITHUB_STEP_SUMMARY"
                    echo "Run URL: ${{ github.event.workflow_run.html_url }}" >> "$GITHUB_STEP_SUMMARY"
          EOF
          # Remove leading spaces from appended heredoc (strip 10 spaces)
          sed -i 's/^          //' notifications.yml.tmp

      - name: Commit and push notifications.yml if changed
        run: |
          set -euo pipefail
          cd .github/workflows
          # Only commit if different
          if ! git diff --quiet -- notifications.yml notifications.yml.tmp; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            mv notifications.yml.tmp notifications.yml
            git add notifications.yml
            git commit -m "ci: sync workflow names for notifications" || true
            git push origin HEAD:main
          else
            echo "No notifications.yml change detected"
          fi
